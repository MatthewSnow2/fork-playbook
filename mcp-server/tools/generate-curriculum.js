/**
 * MCP Tool: generate_curriculum
 *
 * Wrapper around CLI generate-curriculum command for MCP integration.
 */

import { createClient } from '../../cli/lib/claude-client.js';
import { SYSTEM_PROMPT, buildUserPrompt, estimateTokens } from '../../cli/lib/prompts/curriculum-prompt.js';
import { validateCurriculum } from '../../cli/lib/validators/schema-validator.js';
import fs from 'fs/promises';
import path from 'path';

/**
 * Handle generate_curriculum tool call from MCP.
 *
 * @param {Object} args - Tool arguments
 * @returns {Object} - MCP tool response
 */
export async function handleGenerateCurriculum(args) {
  const {
    topic,
    chapters = 10,
    difficulty = 'intermediate',
    duration = 45,
    outputDir = './generated',
    dryRun = false
  } = args;

  // Estimate tokens and cost
  const estimates = estimateTokens(chapters);
  const inputCost = (estimates.inputTokens / 1000) * 0.003;
  const outputCost = (estimates.outputTokens / 1000) * 0.015;
  const totalCost = inputCost + outputCost;

  if (dryRun) {
    return {
      content: [
        {
          type: 'text',
          text: `üìä **Cost Estimation for "${topic}"**

**Parameters:**
- Chapters: ${chapters}
- Difficulty: ${difficulty}
- Duration: ${duration} min/chapter

**Token Estimates:**
- Input: ~${estimates.inputTokens.toLocaleString()} tokens
- Output: ~${estimates.outputTokens.toLocaleString()} tokens
- Total: ~${estimates.totalTokens.toLocaleString()} tokens

**Estimated Cost:** $${totalCost.toFixed(2)}

Note: Actual cost may vary based on content length.`
        }
      ]
    };
  }

  // Validate API key
  if (!process.env.ANTHROPIC_API_KEY) {
    return {
      content: [
        {
          type: 'text',
          text: '‚ùå **Error:** ANTHROPIC_API_KEY not set.\n\nPlease set your API key in the environment before generating curriculum.\n\nGet your API key at: https://console.anthropic.com/'
        }
      ],
      isError: true
    };
  }

  try {
    const client = createClient();
    const userPrompt = buildUserPrompt({ topic, chapters, difficulty, duration });

    // Generate curriculum
    const startTime = Date.now();
    const curriculum = await client.sendMessageForJSON({
      systemPrompt: SYSTEM_PROMPT,
      userPrompt,
      maxTokens: Math.min(estimates.outputTokens * 1.5, 32000)
    });
    const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);

    // Validate
    const validation = validateCurriculum(curriculum);

    if (!validation.valid) {
      return {
        content: [
          {
            type: 'text',
            text: `‚ùå **Validation Failed**

Errors:
${validation.errors.map(e => `- ${e}`).join('\n')}

${validation.warnings.length > 0 ? `Warnings:\n${validation.warnings.map(w => `- ${w}`).join('\n')}` : ''}

Please try again.`
          }
        ],
        isError: true
      };
    }

    // Write output files
    await fs.mkdir(outputDir, { recursive: true });

    const chaptersContent = `// Generated by Adaptive Learning Curriculum Generator
// Topic: ${topic}
// Generated: ${new Date().toISOString()}

export const chaptersData = ${JSON.stringify(curriculum.chaptersData, null, 2)};
`;
    await fs.writeFile(path.join(outputDir, 'chapters.js'), chaptersContent);

    const fullChaptersContent = `// Generated by Adaptive Learning Curriculum Generator
// Topic: ${topic}
// Generated: ${new Date().toISOString()}

export const fullChapterContent = ${JSON.stringify(curriculum.fullChapterContent, null, 2)};
`;
    await fs.writeFile(path.join(outputDir, 'fullChapters.js'), fullChaptersContent);

    // Write metadata
    const metadata = {
      topic,
      chapters,
      difficulty,
      duration,
      generatedAt: new Date().toISOString(),
      estimatedTokens: estimates,
      generationTime: `${elapsed}s`
    };
    await fs.writeFile(
      path.join(outputDir, 'metadata.json'),
      JSON.stringify(metadata, null, 2)
    );

    // Build summary
    const totalSections = curriculum.chaptersData.reduce((sum, c) => sum + c.sections.length, 0);
    const totalExercises = curriculum.chaptersData.reduce((sum, c) => sum + c.exercises.length, 0);
    const totalQuizQuestions = curriculum.chaptersData.reduce((sum, c) => sum + c.quiz.length, 0);

    return {
      content: [
        {
          type: 'text',
          text: `‚ú® **Curriculum Generated Successfully!**

**Topic:** ${topic}
**Generation Time:** ${elapsed}s

**Output Files:**
- \`${path.join(outputDir, 'chapters.js')}\`
- \`${path.join(outputDir, 'fullChapters.js')}\`
- \`${path.join(outputDir, 'metadata.json')}\`

**Summary:**
- Chapters: ${curriculum.chaptersData.length}
- Sections: ${totalSections}
- Exercises: ${totalExercises}
- Quiz Questions: ${totalQuizQuestions}

${validation.warnings.length > 0 ? `**Warnings:**\n${validation.warnings.slice(0, 5).map(w => `- ${w}`).join('\n')}` : ''}

**Next Steps:**
1. Review generated content
2. Run \`adapt_vark\` to create VARK variants
3. Copy to \`src/data/\` when ready`
        }
      ]
    };

  } catch (error) {
    return {
      content: [
        {
          type: 'text',
          text: `‚ùå **Generation Failed**

Error: ${error.message}

Please check:
1. ANTHROPIC_API_KEY is valid
2. You have sufficient API credits
3. Network connection is stable`
        }
      ],
      isError: true
    };
  }
}

export default handleGenerateCurriculum;
